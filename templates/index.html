<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Monitor</title>
    <link rel="stylesheet" href="/static/style.css">

    <script>
        // This script runs immediately to prevent the flash of the light theme.
        // It makes the dark theme the default.
        (function() {
            // Check if 'light' is explicitly saved, otherwise default to dark.
            if (localStorage.getItem('theme') === 'light') {
                // Do nothing, the default CSS is light theme.
            } else {
                // Apply dark theme by adding the class to the root <html> element.
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
</head>
<body>
    <div id="schedule-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title">Add Schedule</h2>
            <form id="schedule-form">
                <input type="hidden" id="schedule-id" name="id">
                <div class="form-group">
                    <label for="schedule-name">Name</label>
                    <input type="text" id="schedule-name" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="schedule-on-time">ON Time</label>
                        <input type="time" id="schedule-on-time" required>
                    </div>
                    <div class="form-group">
                        <label for="schedule-off-time">OFF Time</label>
                        <input type="time" id="schedule-off-time" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Days</label>
                    <div class="days-selector">
                        <span><input type="checkbox" id="day-0" data-day="0"><label for="day-0">Mon</label></span>
                        <span><input type="checkbox" id="day-1" data-day="1"><label for="day-1">Tue</label></span>
                        <span><input type="checkbox" id="day-2" data-day="2"><label for="day-2">Wed</label></span>
                        <span><input type="checkbox" id="day-3" data-day="3"><label for="day-3">Thu</label></span>
                        <span><input type="checkbox" id="day-4" data-day="4"><label for="day-4">Fri</label></span>
                        <span><input type="checkbox" id="day-5" data-day="5"><label for="day-5">Sat</label></span>
                        <span><input type="checkbox" id="day-6" data-day="6"><label for="day-6">Sun</label></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Temperature Condition (Optional)</label>
                    <div class="form-grid">
                        <select id="schedule-temp-condition">
                            <option value="none">Always activate</option>
                            <option value="below">If temp is below</option>
                            <option value="above">If temp is above</option>
                        </select>
                        <input type="number" id="schedule-temp-threshold" step="0.1" placeholder="e.g., 10.5">
                    </div>
                </div>
                <div class="form-group">
                    <label for="schedule-priority-on">Priority when ON</label>
                     <select id="schedule-priority-on">
                        <option value="0">CH Priority</option>
                        <option value="1">DHW Priority</option>
                        <option value="2">Parallel Pumps</option>
                        <option value="3">Summer Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="schedule-enabled">Enabled</label>
                    <input type="checkbox" id="schedule-enabled" checked>
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel">Cancel</button>
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ESP32 Pellet Burner Monitor</h1>
            <div class="header-right">
                <span id="last-update">Last update: ...</span>
                <button id="theme-toggle">üåô</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'dashboard')">Dashboard</button>
            <button class="tab-link" onclick="openTab(event, 'scheduler')">Scheduler</button>
        </nav>

        <main>
            <div id="dashboard" class="tab-content" style="display: block;">
                <div class="card-grid">
                    <div class="card">
                        <h2>Burner Status</h2>
                        <p><strong>Mode:</strong> <span id="burner-mode">...</span></p>
                        <p><strong>State:</strong> <span id="burner-state">...</span></p>
                        <p><strong>Status:</strong> <span id="burner-status">...</span></p>
                        <p><strong>Power:</strong> <span id="burner-power">...</span></p>
                        <p><strong>Flame Strength:</strong> <span id="burner-flame">...</span></p>
                    </div>

                    <div class="card">
                        <h2>Temperatures</h2>
                        <p><strong>Boiler (Actual):</strong> <span id="temp-boiler">...</span> &deg;C</p>
                        <p><strong>Boiler (Set):</strong> <span id="temp-set">...</span> &deg;C</p>
                        <p><strong>DHW:</strong> <span id="temp-dhw">...</span> &deg;C</p>
                        <p><strong>Return Water (DS18):</strong> <span id="temp-tds18">...</span> &deg;C</p>
                        <p><strong>Exhaust Gas (K-Type):</strong> <span id="temp-ktype">...</span> &deg;C</p>
                        <p><strong>Ambient (BMP):</strong> <span id="temp-tbmp">...</span> &deg;C</p>
                    </div>

                    <div class="card">
                        <h2>System & Pumps</h2>
                        <p><strong>DHW Pump:</strong> <span id="pump-dhw">...</span></p>
                        <p><strong>CH Pump:</strong> <span id="pump-ch">...</span></p>
                        <p><strong>Fan Speed:</strong> <span id="fan-speed">...</span> %</p>
                        <p><strong>Ambient Pressure:</strong> <span id="pressure-pbmp">...</span> hPa</p>
                        <p><strong>Ambient Humidity:</strong> <span id="humidity">...</span> %</p>
                        <p><strong>SW Version:</strong> <span id="sw-ver">...</span></p>
                    </div>

                    <div class="card">
                        <h2>Controls</h2>
                        <form id="settings-form">
                            <div class="form-group">
                                <label for="mode-select">Mode:</label>
                                <select id="mode-select" name="mode">
                                    <option value="0">Standby</option>
                                    <option value="1">Auto</option>
                                    <option value="2">Timer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="priority-select">Priority:</label>
                                <select id="priority-select" name="priority">
                                    <option value="0">CH Priority</option>
                                    <option value="1">DHW Priority</option>
                                    <option value="2">Parallel Pumps</option>
                                    <option value="3">Summer Mode</option>
                                </select>
                            </div>
                            <button type="submit">Set Mode & Priority</button>
                        </form>
                        <p id="form-status"></p>
                        <div class="update-section">
                            <hr>
                            <button id="update-button">Check for Updates</button>
                            <p id="update-status"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="scheduler" class="tab-content">
                <div class="card">
                    <div class="scheduler-header">
                        <h2>Schedules</h2>
                        <button id="add-schedule-btn">+ Add Schedule</button>
                    </div>
                    <div id="schedule-list">
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- THEME TOGGLE LOGIC ---
        const themeToggle = document.getElementById('theme-toggle');
        if (document.documentElement.classList.contains('dark-mode')) {
            themeToggle.textContent = '‚òÄÔ∏è';
        } else {
            themeToggle.textContent = 'üåô';
        }
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark-mode');
            if (document.documentElement.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'üåô';
            }
        });

        // --- TAB SWITCHING LOGIC ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // --- DATA FETCHING AND UI UPDATING ---
        function updateUI(data) {
            const burner = data.burner || {};
            const sensors = data.sensors || {};
            document.getElementById('last-update').textContent = `Last update: ${data.last_update || '...'}`;
            document.getElementById('burner-mode').textContent = burner.Mode || 'N/A';
            document.getElementById('burner-state').textContent = burner.State || 'N/A';
            document.getElementById('burner-status').textContent = burner.Status || 'N/A';
            document.getElementById('burner-power').textContent = burner.Power || 'N/A';
            document.getElementById('burner-flame').textContent = burner.Flame || 'N/A';
            document.getElementById('temp-boiler').textContent = burner.Tboiler || 'N/A';
            document.getElementById('temp-set').textContent = burner.Tset || 'N/A';
            document.getElementById('temp-dhw').textContent = burner.DHW || 'N/A';
            document.getElementById('temp-tds18').textContent = sensors.TDS18 || 'N/A';
            document.getElementById('temp-ktype').textContent = sensors.KTYPE || 'N/A';
            document.getElementById('temp-tbmp').textContent = sensors.TBMP || 'N/A';
            document.getElementById('pump-dhw').textContent = burner.DHWPump || 'N/A';
            document.getElementById('pump-ch').textContent = burner.CHPump || 'N/A';
            document.getElementById('fan-speed').textContent = burner.Fan || 'N/A';
            document.getElementById('pressure-pbmp').textContent = sensors.PBMP || 'N/A';
            document.getElementById('humidity').textContent = sensors.HUM || 'N/A';
            document.getElementById('sw-ver').textContent = burner.SwVer || 'N/A';
        }
        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Failed to fetch data:', error);
            }
        }

        // --- SETTINGS FORM LOGIC ---
        const settingsForm = document.getElementById('settings-form');
        const formStatus = document.getElementById('form-status');
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formStatus.textContent = 'Sending...';
            const formData = new FormData(settingsForm);
            const data = {
                mode: parseInt(formData.get('mode'), 10),
                priority: parseInt(formData.get('priority'), 10)
            };
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    formStatus.textContent = 'Settings updated!';
                } else { throw new Error('Failed to update settings'); }
            } catch (error) {
                console.error(error);
                formStatus.textContent = 'Error sending settings.';
            }
            setTimeout(() => { formStatus.textContent = ''; }, 3000);
        });

        // --- OTA UPDATE LOGIC ---
        const updateButton = document.getElementById('update-button');
        const updateStatus = document.getElementById('update-status');
        updateButton.addEventListener('click', async () => {
            updateStatus.textContent = 'Checking for updates...';
            updateButton.disabled = true;
            try {
                const response = await fetch('/api/update', { method: 'POST' });
                const result = await response.json();
                if (result.status === 'success') {
                    updateStatus.textContent = 'Update successful! Rebooting...';
                } else {
                    updateStatus.textContent = result.message;
                }
            } catch (error) {
                console.error('Update failed:', error);
                updateStatus.textContent = 'An error occurred during the update.';
            } finally {
                setTimeout(() => {
                    updateButton.disabled = false;
                    updateStatus.textContent = '';
                }, 5000);
            }
        });

        // --- SCHEDULER UI LOGIC ---
        const modal = document.getElementById('schedule-modal');
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const scheduleForm = document.getElementById('schedule-form');
        const scheduleListDiv = document.getElementById('schedule-list');
        let schedules = [];

        function renderSchedules() {
            scheduleListDiv.innerHTML = '';
            if (schedules.length === 0) {
                scheduleListDiv.innerHTML = '<p>No schedules configured.</p>';
                return;
            }
            schedules.forEach(sched => {
                const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
                const activeDays = sched.days.map((d, i) => d ? `<strong>${days[i]}</strong>` : `<span>${days[i]}</span>`).join(' ');
                let tempRule = 'Always';
                if(sched.temp_condition !== 'none') {
                    tempRule = `If Temp ${sched.temp_condition === 'below' ? '&lt;' : '&gt;'} ${sched.temp_threshold}¬∞C`;
                }
                const schedDiv = document.createElement('div');
                schedDiv.className = 'schedule-item' + (sched.enabled ? '' : ' disabled');
                schedDiv.innerHTML = `
                    <div class="schedule-info">
                        <strong>${sched.name}</strong>
                        <span>ON: ${sched.on_time}, OFF: ${sched.off_time}</span>
                        <span class="schedule-days">${activeDays}</span>
                        <span class="schedule-temp">${tempRule}</span>
                    </div>
                    <div class="schedule-actions">
                        <button class="edit-btn" data-id="${sched.id}">Edit</button>
                        <button class="delete-btn" data-id="${sched.id}">Delete</button>
                    </div>
                `;
                scheduleListDiv.appendChild(schedDiv);
            });
        }
        async function fetchSchedules() {
            try {
                const response = await fetch('/api/schedules');
                schedules = await response.json();
                renderSchedules();
            } catch (e) { console.error('Failed to fetch schedules', e); }
        }
        function openModal(schedule = null) {
            scheduleForm.reset();
            document.getElementById('schedule-temp-threshold').style.display = 'none';
            if (schedule) {
                document.getElementById('modal-title').textContent = 'Edit Schedule';
                document.getElementById('schedule-id').value = schedule.id;
                document.getElementById('schedule-name').value = schedule.name;
                document.getElementById('schedule-on-time').value = schedule.on_time;
                document.getElementById('schedule-off-time').value = schedule.off_time;
                document.getElementById('schedule-enabled').checked = schedule.enabled;
                document.getElementById('schedule-priority-on').value = schedule.priority_on;
                schedule.days.forEach((day, i) => { document.getElementById(`day-${i}`).checked = day; });
                const condition = schedule.temp_condition || 'none';
                document.getElementById('schedule-temp-condition').value = condition;
                if(condition !== 'none'){
                    document.getElementById('schedule-temp-threshold').style.display = 'block';
                    document.getElementById('schedule-temp-threshold').value = schedule.temp_threshold;
                }
            } else {
                document.getElementById('modal-title').textContent = 'Add Schedule';
                document.getElementById('schedule-id').value = '';
            }
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        addScheduleBtn.addEventListener('click', () => openModal());
        modalCancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        document.getElementById('schedule-temp-condition').addEventListener('change', (e) => {
            const thresholdInput = document.getElementById('schedule-temp-threshold');
            thresholdInput.style.display = e.target.value === 'none' ? 'none' : 'block';
        });
        scheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const days = Array.from({length: 7}, (_, i) => document.getElementById(`day-${i}`).checked);
            const scheduleData = {
                id: document.getElementById('schedule-id').value ? parseInt(document.getElementById('schedule-id').value) : null,
                name: document.getElementById('schedule-name').value,
                on_time: document.getElementById('schedule-on-time').value,
                off_time: document.getElementById('schedule-off-time').value,
                days: days,
                temp_condition: document.getElementById('schedule-temp-condition').value,
                temp_threshold: parseFloat(document.getElementById('schedule-temp-threshold').value) || 0,
                priority_on: parseInt(document.getElementById('schedule-priority-on').value),
                enabled: document.getElementById('schedule-enabled').checked
            };
            try {
                await fetch('/api/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });
                fetchSchedules();
                closeModal();
            } catch (err) { console.error('Failed to save schedule', err); }
        });
        scheduleListDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const id = parseInt(e.target.dataset.id);
                const scheduleToEdit = schedules.find(s => s.id === id);
                if (scheduleToEdit) openModal(scheduleToEdit);
            }
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                if (confirm('Are you sure you want to delete this schedule?')) {
                    try {
                        await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
                        fetchSchedules();
                    } catch (err) { console.error('Failed to delete schedule', err); }
                }
            }
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchSchedules();
            fetchData();
        });
        setInterval(fetchData, 5000);
    </script>
</body>
</html>
